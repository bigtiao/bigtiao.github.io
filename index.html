<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="打螺丝闲暇的记录">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="打螺丝闲暇的记录">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="一骗树">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>打螺丝闲暇的记录</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">打螺丝闲暇的记录</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-sitemap fa-fw"></i>Links</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/29/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B49%E6%AE%B5%E7%BA%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/29/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B49%E6%AE%B5%E7%BA%BF/" class="post-title-link" itemprop="url">数据分析思维9段线</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-29 21:11:00 / 修改时间：21:15:07" itemprop="dateCreated datePublished" datetime="2022-12-29T21:11:00+08:00">2022-12-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">数据</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>正文开始<br>我做了 10 多年的数据分析，期间有很多同学问我，数据分析主要有哪些思维？学习的路线是怎么样的？<br>为了提供一个简单的方向指引，让数据分析思维的学习过程更加有趣，我做了一幅数据分析思维九段路线图，你可以把学习的过程当作一种游戏，享受段位升级的乐趣。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221229211251.png" alt="20221229211251"><br>在段位升级的过程中，如果你理解起来感觉比较吃力，那么应该沉下心来，认真地先把基础打好，积累更多的数据分析经验。</p>
<ol>
<li>初段：目标思维<br>做数据分析，首先要一定明确目标，以终为始。<br>只有明确目标，才不会迷失方向，就像导航软件，如果没有设置目的地，那么它是没法告诉你路线图的。<br>目标思维主要体现在以下 3 个方面：<br>（1）正确地定义问题<br>比如说，小明听了煎饼大妈月入 3 万的故事，心里就想：为什么煎饼大妈月入 3 万？<br>这个问题的定义，应该是关注「月入 3 万」，而不是「煎饼大妈」。<br>也就是说，小明想的应该是「如何实现月入 3 万」，而不是「如何变成煎饼大妈」。<br>（2）合理地分解问题<br>比如说，煎饼大妈如何实现月收入 3 万？<br>这是一个比较大的问题，可以进行细分，因为收入等于订单数乘以客单价，所以把这个问题细分为两个小问题：<br>a. 如何实现一个月卖 5000 个煎饼？<br>b. 如何实现平均每个煎饼卖 6 块钱？<br>（3）抓住关键的问题<br>在不同的发展阶段，关键问题是不一样的。<br>比如说，对煎饼大妈来讲，刚开始做的时候，关键问题是：如何选择人流量大的好地段？<br>当选好地段之后，关键问题就变成：如何提高路人来购买的概率？如何提高客单价？如何提高重复购买率？<br>总之，数据分析的目标，就好比枪上的瞄准器，如果没有瞄准器，枪照样可以打，但是有了瞄准器，枪才可以打的更准。</li>
<li>二段：对比思维<br>有人说：<br>没有对比，就没有伤害。<br>在数据分析中，没有对比，就没有结论。<br>比如说，小明某次期末考试的成绩不好，英语只得了 30 分，小明的妈妈对他说：“你上次考试英语考了 70 分，这次怎么就考得这么差？你看你的同班同学，这次都考 80 分以上。”<br>常见的对比思维有以下 5 种：<br>（1）跟目标对比<br>（2）跟上个月比<br>（3）跟去年同比<br>（4）分渠道对比<br>（5）跟同类对比<br>数据分析的过程，就是在明确目标之后，通过对比等思维，找到问题的原因，得出分析的结论，提出可行的建议，从而起到帮助决策和指导行动的作用。</li>
<li>三段：细分思维<br>有人说：<br>不自由，毋宁死。<br>在数据分析中，细分是数据分析的灵魂，无细分，毋宁死。<br>比如说，小明某次考试的总成绩不好，细分一看，发现其他科目的成绩都不错，只有英语成绩特别差，只得了 30 分，从而拉低了整体的成绩。<br>常见的细分方法有以下 5 种：<br>（1）按时间细分<br>（2）按空间细分<br>（3）按过程细分<br>（4）按公式细分<br>（5）按模型细分<br>在运用细分思维解决问题的过程中，要做到有的放矢，围绕数据分析的目标，找到合适的方法，不要像无头苍蝇一样到处乱撞。<br>当发现数据异常时，尝试从不同的维度进行细分，这样既能锻炼你的数据分析思维，又能加深你对业务的理解。</li>
<li>四段：溯源思维<br>做数据分析的时候，要多问几个为什么，追根溯源，在数据源寻找可能隐藏的逻辑关系和解决方案。<br>比如说，小明把自己每天的行动数据，都用 Excel 详细记录下来，其中包括每一时段的情绪数据。小明做复盘总结的时候，发现有一天情绪数据特别低，然后连续问了几个为什么：<br>（1）为什么这一天情绪数据特别低？<br>因为那一天小明上当受骗了。<br>（2）为什么会上当受骗？<br>因为骗子用生命安全来吓小明。<br>（3）为什么骗子能吓到小明？<br>因为小明担心自己的生命安全。<br>（4）为什么小明会担心生命安全？<br>因为求生是人类的本能反应。<br>（5）为什么人会有求生的本能？<br>因为人的大脑分为：年代久远的本能脑、相对古老的情绪脑和非常年轻的理智脑。<br>理智脑对大脑的控制能力很弱，大部分决策往往源于本能和情绪，而非理智。<br>到这一步，小明找到了自己上当受骗的根本原因，在于自己当时没有控制好自己的大脑，所以失去理智。<br>针对这个问题，小明运用「控制两分法」，并在脑海中反复进行演练，然后在实践中进行校正，实现与情绪的和平共处，从而更加理智地面对纷繁复杂的世界。<br>如果你经常运用溯源思维，就能提升数据的敏感度，并加深对业务的理解。</li>
<li>五段：相关思维<br>相关思维，就是寻找变量之间相互关联的程度。<br>比如说，有一家超市的数据分析师发现，跟尿布一起购买最多的商品竟然是啤酒，啤酒和尿布有什么关联呢？<br>采访小明的爸爸，他说自己下班后，给小明的妹妹买尿布的同时，也会购买自己喜欢喝的啤酒。<br>如果一个变量改变的时候，另一个变量也朝着相同的方向发生变化，那么我们就说这两个变量之间存在正相关性。<br>运用相关思维，通常包括以下 3 个步骤：<br>（1）收集相关数据<br>（2）绘制散点图形<br>（3）计算相关系数<br>需要注意的是，相关不等于因果。即使两个变量之间相关，也不代表其中一个变量的改变，是由另一个变量的变化引起的。<br>比如说，国家的诺贝尔奖数量，与巧克力消费量之间呈现正相关关系，但这并不是说，多吃巧克力有助于获得更多的诺贝尔奖。<br>一种合理的解释是，诺贝尔奖的数量与巧克力的消费量，很可能都是由其他变量导致的，例如国民的受教育程度和富裕程度。</li>
<li>六段：假设思维<br>胡适先生说过：<br>大胆假设，小心求证。<br>这句话非常适合用在数据分析领域。<br>大胆假设，就是要打破既有观念的束缚，挣破旧有思想的牢笼，大胆创新，对未解决的问题提出新的假设。<br>小心求证，就是基于上面的假设，用一种严谨务实的态度，寻找真相，不能有半点马虎。<br>比如说，有一天小明去买水果，跟卖水果的阿姨说：<br>“阿姨，你这桔子甜不甜？”<br>阿姨：“甜啊，不信你试试。”<br>小明：“好，那我试一个。”<br>小明剥开一个桔子，尝了一口说：<br>“嗯，不错，确实挺甜的，给我称两斤。”<br>运用假设思维，通常包括以下 3 个步骤：<br>（1）提出假设<br>（2）统计检验<br>（3）做出判断<br>大胆假设并非绝对可靠，但是通过小心求证，我们可以更好地认识世界上的许多现象，从而得出更有价值的分析结论。</li>
<li>七段：逆向思维<br>到了七段，你已经具备比较丰富的数据分析经验，此时如果想要进一步有所突破，就得打破常规，具有逆向思维的能力。<br>比如说，有一天小明去买西红柿：“阿姨，你这西红柿多少钱一斤？”<br>阿姨：“两块五。”<br>小明挑了 3 个放到秤盘：“阿姨，帮我称一下。”<br>阿姨：“一斤半，3 块 7 毛。”<br>小明去掉其中最大的西红柿：“做汤不用那么多。”<br>阿姨：“一斤二两，3 块。”<br>小明拿起刚刚去掉的那个最大的西红柿，付了 7 毛钱，扭头就走了。<br>你看，本来是阿姨想占小明的便宜，虚报重量。但是，小明利用逆向思维，反而让阿姨吃了哑巴亏。<br>常见的逆向思维有以下 5 种：<br>（1）结构逆向<br>（2）功能逆向<br>（3）状态逆向<br>（4）原理逆向<br>（5）方法逆向<br>理解这些逆向的方法，有助于你打开数据分析的思路，不断提升自己的可迁移能力，尤其是底层的思维能力，做到以不变应万变。</li>
<li>八段：演绎思维<br>演绎思维的方向是由一般到个别，主要形式是「三段论」，由大前提、小前提、结论三部分组成。<br>比如说，小明不仅知道：金属都能导电；而且知道：铜是一种金属；所以小明可以得出结论：铜能导电。<br>运用演绎思维，应该遵循 5 项基本原则：<br>（1）不要出现第四个概念<br>（2）中项要能向外延伸<br>（3）大项和小项都不能扩大<br>（4）前提都为否，结论不必然<br>（5）前提有一否，结论必为否<br>掌握以上基本原则，能帮你建立更加严谨的数据分析思维。</li>
<li>九段：归纳思维<br>归纳思维的方向与演绎正好相反，归纳的过程是从个别到一般。<br>比如说，小明先知道：金、银、铜、铁等金属分别能导电，然后归纳出一个结论：所有金属都能导电。<br>这个过程，是先接触到个别事物，然后再进行归纳总结。<br>常见的归纳方法有以下 5 种：<br>（1）求同法<br>（2）求异法<br>（3）共用法<br>（4）共变法<br>（5）剩余法<br>这些方法是我们获取新知识的重要途径，不过需要注意的是，很多案例和故事都说明，有限的观察并不等于真理。<br>为了避免以偏概全，我们还要加强归纳思维的训练，积累更多实战的经验，这样归纳总结出来的结论，才能经得起时间的考验，才会更有现实意义。<br>通过归纳总结，得出有价值的分析结论，这既是数据分析的终点，也是数据分析的起点，形成一个正向的循环系统。<br>最后的话<br>正确的思维能力，是做好数据分析的必备条件，这也是很多人相对比较欠缺的一种能力。<br>要想成为一个有洞察力的人，就要多学习、多思考、多总结、多实践，通过刻意练习，举一反三，把数据分析的思维，应用到日常的工作和生活中去，逐渐提升自己的数据分析思维能力。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/24/ABAP%E5%8F%91%E7%A5%A8%E9%A2%84%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/24/ABAP%E5%8F%91%E7%A5%A8%E9%A2%84%E5%88%B6/" class="post-title-link" itemprop="url">ABAP发票预制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-24 14:52:02 / 修改时间：14:57:44" itemprop="dateCreated datePublished" datetime="2022-11-24T14:52:02+08:00">2022-11-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAP/" itemprop="url" rel="index"><span itemprop="name">SAP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>MIR7的发票预制，不需要过账</p>
<p>1、BAPI_INCOMINGINVOICE_PARK<br>2、BAPI_INCOMINGINVOICE_CREATE<br>3、BAPI_INCOMINGINVOICE_CREATE1</p>
<p>1和2的价格可以输负数<br>2创建的发票直接过账</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>BAPI_INCOMINGINVOICE_PARK例子</p>
<p>需要注意：发票有四种事务类型，可以通过BAPI参数进行设置</p>
<p>“发票:       headerdata-invoice_ind &#x3D; ‘X’    itemdata-de_cre_ind &#x3D; space<br>“贷项凭证:   headerdata-invoice_ind &#x3D; space  itemdata-de_cre_ind &#x3D; space<br>“后续借记:   headerdata-invoice_ind &#x3D; ‘X’    itemdata-de_cre_ind &#x3D; ‘X’<br>“后续贷记:   headerdata-invoice_ind &#x3D; space  itemdata-de_cre_ind &#x3D; ‘X’</p>
<p>如果设置税率自动计算，则不需要传taxitem</p>
<p>发票和后续借记金额传正数，贷项凭证和后续贷记金额传负数</p>
<p>参照凭证必须传输，否则报错，默认借方凭证找101，贷方找161退货凭证，EKBE表找</p>
<ol>
<li>新增</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">FORM FRM_SAVE_FOR_CREATE .</span><br><span class="line"> </span><br><span class="line">  DATA: LS_HEADERDATA          TYPE BAPI_INCINV_CREATE_HEADER,</span><br><span class="line">        LS_ADDRESSDATA         TYPE BAPI_INCINV_CREATE_ADDRESSDATA,</span><br><span class="line">        LV_INVOICEDOCNUMBER    TYPE BAPI_INCINV_FLD-INV_DOC_NO,</span><br><span class="line">        LV_FISCALYEAR          TYPE BAPI_INCINV_FLD-FISC_YEAR,</span><br><span class="line">        LT_ITEMDATA            TYPE TABLE OF BAPI_INCINV_CREATE_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_ACCOUNTINGDATA      TYPE TABLE OF BAPI_INCINV_CREATE_ACCOUNT WITH HEADER LINE,</span><br><span class="line">        LT_GLACCOUNTDATA       TYPE TABLE OF BAPI_INCINV_CREATE_GL_ACCOUNT WITH HEADER LINE,</span><br><span class="line">        LT_MATERIALDATA        TYPE TABLE OF BAPI_INCINV_CREATE_MATERIAL WITH HEADER LINE,</span><br><span class="line">        LT_TAXDATA             TYPE TABLE OF BAPI_INCINV_CREATE_TAX WITH HEADER LINE,</span><br><span class="line">        LT_WITHTAXDATA         TYPE TABLE OF BAPI_INCINV_CREATE_VENDORSPLIT WITH HEADER LINE,</span><br><span class="line">        LT_VENDORITEMSPLITDATA TYPE TABLE OF BAPI_INCINV_CREATE_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_RETURN              TYPE TABLE OF BAPIRET2 WITH HEADER LINE,</span><br><span class="line">        LT_EXTENSIONIN         TYPE TABLE OF BAPI_INCINV_CREATE_TM_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_TM_ITEMDATA         TYPE TABLE OF /NFM/BAPIDOCITM WITH HEADER LINE,</span><br><span class="line">        LV_WRBTR               TYPE BAPIWRBTR,</span><br><span class="line">        LT_FTAXP               TYPE TABLE OF FTAXP,</span><br><span class="line">        LV_ITEM                TYPE  RBLGP,</span><br><span class="line">        LV_MESSAGE             TYPE STRING,</span><br><span class="line">        LV_POST_MSG            TYPE CHAR300,</span><br><span class="line">        LV_ICON                TYPE CHAR04,</span><br><span class="line">        LV_STATUS              TYPE CHAR01.</span><br><span class="line"> </span><br><span class="line">  DATA(LT_ONLY) = GT_RBKP_DATA.</span><br><span class="line"> </span><br><span class="line">  DELETE LT_ONLY WHERE BOX IS INITIAL OR BELNR IS NOT INITIAL.</span><br><span class="line"> </span><br><span class="line">  SORT LT_ONLY BY LIFNR.</span><br><span class="line">  DELETE ADJACENT DUPLICATES FROM LT_ONLY COMPARING LIFNR.</span><br><span class="line"> </span><br><span class="line">  &quot; 数据校验</span><br><span class="line">  LOOP AT LT_ONLY INTO DATA(LS_ONLY).</span><br><span class="line">    CLEAR:LV_STATUS,LS_HEADERDATA,LT_ITEMDATA[],LT_TAXDATA[].</span><br><span class="line">    LOOP AT GT_RBKP_DATA INTO GS_RBKP_DATA WHERE BOX = &#x27;X&#x27; AND LIFNR = LS_ONLY-LIFNR AND TYPE NE LS_ONLY-TYPE.</span><br><span class="line">      LV_STATUS = &#x27;E&#x27;.</span><br><span class="line">      GS_RBKP_DATA-ICON = ICON_LED_RED.</span><br><span class="line">      GS_RBKP_DATA-MSG = &#x27;同一个供应商下，事务类型不同；&#x27;.</span><br><span class="line">      MODIFY GT_RBKP_DATA FROM GS_RBKP_DATA TRANSPORTING ICON MSG WHERE BOX = &#x27;X&#x27; AND LIFNR = LS_ONLY-LIFNR.</span><br><span class="line">      EXIT.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    CASE LS_ONLY-TYPE+0(1).</span><br><span class="line">      WHEN &#x27;1&#x27; OR &#x27;3&#x27;.</span><br><span class="line">        LS_HEADERDATA-INVOICE_IND = &#x27;X&#x27;.</span><br><span class="line">      WHEN &#x27;2&#x27; OR &#x27;4&#x27;.</span><br><span class="line">        LS_HEADERDATA-INVOICE_IND = SPACE.</span><br><span class="line">      WHEN OTHERS.</span><br><span class="line">    ENDCASE.</span><br><span class="line">    LS_HEADERDATA-DOC_TYPE = &#x27;RE&#x27;. &quot;凭证类型</span><br><span class="line">    LS_HEADERDATA-DOC_DATE = LS_ONLY-BLDAT. &quot;凭证日期</span><br><span class="line">    LS_HEADERDATA-PSTNG_DATE = LS_ONLY-BUDAT. &quot;过账日期</span><br><span class="line">    LS_HEADERDATA-BLINE_DATE = LS_ONLY-ZFBDT.  &quot;基准日期</span><br><span class="line">    LS_HEADERDATA-COMP_CODE = LS_ONLY-BUKRS. &quot;公司代码</span><br><span class="line">    LS_HEADERDATA-DIFF_INV = LS_ONLY-LIFNR.  &quot;供应商</span><br><span class="line">    LS_HEADERDATA-CURRENCY = LS_ONLY-WAERS. &quot; 货币</span><br><span class="line">    LS_HEADERDATA-DELIV_POSTING = &#x27;S&#x27;.</span><br><span class="line">    LS_HEADERDATA-RETURN_POSTING = &#x27;H&#x27;.</span><br><span class="line">    LS_HEADERDATA-REF_DOC_NO = LS_ONLY-XBLNR. &quot; 参考</span><br><span class="line">    LS_HEADERDATA-HEADER_TXT = LS_ONLY-BKTXT. &quot; 抬头文本</span><br><span class="line">    IF LS_ONLY-CAL_IND IS NOT INITIAL.</span><br><span class="line">      LS_HEADERDATA-CALC_TAX_IND = &#x27;X&#x27;.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    LOOP AT GT_RBKP_DATA INTO GS_RBKP_DATA WHERE BOX = &#x27;X&#x27; AND LIFNR = LS_ONLY-LIFNR.</span><br><span class="line">      CLEAR:LT_ITEMDATA.</span><br><span class="line">      LV_ITEM = LV_ITEM + 10.</span><br><span class="line">      LT_ITEMDATA-INVOICE_DOC_ITEM = LV_ITEM.</span><br><span class="line">      LT_ITEMDATA-PO_NUMBER = GS_RBKP_DATA-EBELN. &quot; 采购订单号</span><br><span class="line">      LT_ITEMDATA-PO_ITEM = GS_RBKP_DATA-EBELP. &quot; 采购订单行号</span><br><span class="line">      LT_ITEMDATA-TAX_CODE = GS_RBKP_DATA-MWSKZ. &quot; 税码</span><br><span class="line">      LT_ITEMDATA-ITEM_AMOUNT = GS_RBKP_DATA-WRBTR. &quot; 价格</span><br><span class="line">      IF LS_HEADERDATA-INVOICE_IND NE &#x27;X&#x27;.</span><br><span class="line">        LT_ITEMDATA-ITEM_AMOUNT = LT_ITEMDATA-ITEM_AMOUNT * -1.</span><br><span class="line">      ENDIF.</span><br><span class="line">      LT_ITEMDATA-QUANTITY = GS_RBKP_DATA-MENGE. &quot; 开票数</span><br><span class="line">      LT_ITEMDATA-PO_UNIT = GS_RBKP_DATA-MEINS. &quot; 单位</span><br><span class="line">      LT_ITEMDATA-ITEM_TEXT = GS_RBKP_DATA-SGTXT. &quot; 文本</span><br><span class="line"> </span><br><span class="line">      CASE LS_ONLY-TYPE+0(1).</span><br><span class="line">        WHEN &#x27;1&#x27; OR &#x27;2&#x27;.</span><br><span class="line">          LT_ITEMDATA-DE_CRE_IND  = SPACE.</span><br><span class="line">        WHEN &#x27;3&#x27; OR &#x27;4&#x27;.</span><br><span class="line">          LT_ITEMDATA-DE_CRE_IND = &#x27;X&#x27;.</span><br><span class="line">        WHEN OTHERS.</span><br><span class="line">      ENDCASE.</span><br><span class="line"> </span><br><span class="line">      SELECT</span><br><span class="line">        *</span><br><span class="line">        INTO TABLE @DATA(LT_REF)</span><br><span class="line">        FROM EKBE</span><br><span class="line">        WHERE EBELN = @GS_RBKP_DATA-EBELN AND</span><br><span class="line">              EBELP = @GS_RBKP_DATA-EBELP AND</span><br><span class="line">              BEWTP = &#x27;E&#x27; AND</span><br><span class="line">              BWART IN ( &#x27;101&#x27;, &#x27;105&#x27; , &#x27;161&#x27; ).</span><br><span class="line">      SORT LT_REF BY EBELN EBELP GJAHR DESCENDING BELNR DESCENDING.</span><br><span class="line"> </span><br><span class="line">      &quot; 非退货找101</span><br><span class="line">      IF LS_HEADERDATA-INVOICE_IND IS INITIAL.</span><br><span class="line">          READ TABLE LT_REF INTO DATA(LS_REF) WITH KEY EBELN = GS_RBKP_DATA-EBELN EBELP = GS_RBKP_DATA-EBELP BWART = &#x27;101&#x27;.</span><br><span class="line">      ELSE.</span><br><span class="line">        &quot; 退货找161</span><br><span class="line">        READ TABLE LT_REF INTO LS_REF WITH KEY EBELN = GS_RBKP_DATA-EBELN EBELP = GS_RBKP_DATA-EBELP BWART = &#x27;161&#x27;.</span><br><span class="line">        IF SY-SUBRC NE 0.</span><br><span class="line">          READ TABLE LT_REF INTO LS_REF WITH KEY EBELN = GS_RBKP_DATA-EBELN EBELP = GS_RBKP_DATA-EBELP BWART = &#x27;101&#x27;.</span><br><span class="line">        ENDIF.</span><br><span class="line">      ENDIF.</span><br><span class="line"> </span><br><span class="line">      LT_ITEMDATA-REF_DOC = LS_REF-LFBNR. &quot;参考物料凭证</span><br><span class="line">      LT_ITEMDATA-REF_DOC_YEAR = LS_REF-LFGJA.  &quot;参考年份</span><br><span class="line">      LT_ITEMDATA-REF_DOC_IT = LS_REF-LFPOS.  &quot;参考凭证行</span><br><span class="line">      APPEND LT_ITEMDATA.</span><br><span class="line"> </span><br><span class="line">      CLEAR:LT_FTAXP.</span><br><span class="line">      CALL FUNCTION &#x27;GET_TAX_PERCENTAGE&#x27;</span><br><span class="line">        EXPORTING</span><br><span class="line">          ALAND   = &#x27;CN&#x27;</span><br><span class="line">          DATAB   = SY-DATUM</span><br><span class="line">          MWSKZ   = GS_RBKP_DATA-MWSKZ</span><br><span class="line">          TXJCD   = &#x27;&#x27;</span><br><span class="line">        TABLES</span><br><span class="line">          T_FTAXP = LT_FTAXP.</span><br><span class="line">      READ TABLE LT_FTAXP INTO DATA(LS_FTAXP) INDEX 1.</span><br><span class="line"> </span><br><span class="line">      LT_TAXDATA-ITEMNO_TAX = &#x27;0010&#x27;.</span><br><span class="line">      LT_TAXDATA-TAX_AMOUNT = LT_TAXDATA-TAX_AMOUNT + GS_RBKP_DATA-WRBTR * ( LS_FTAXP-KBETR / 1000 ). &quot; 税额</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    IF LS_ONLY-CAL_IND IS INITIAL.</span><br><span class="line">      APPEND LT_TAXDATA.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    LS_HEADERDATA-GROSS_AMOUNT = LS_ONLY-RMWWR. &quot; 总金额</span><br><span class="line"> </span><br><span class="line">    CALL FUNCTION &#x27;BAPI_INCOMINGINVOICE_PARK&#x27;</span><br><span class="line">      EXPORTING</span><br><span class="line">        HEADERDATA       = LS_HEADERDATA</span><br><span class="line">      IMPORTING</span><br><span class="line">        INVOICEDOCNUMBER = LV_INVOICEDOCNUMBER</span><br><span class="line">        FISCALYEAR       = LV_FISCALYEAR</span><br><span class="line">      TABLES</span><br><span class="line">        ITEMDATA         = LT_ITEMDATA</span><br><span class="line">*       ACCOUNTINGDATA   =</span><br><span class="line">*       GLACCOUNTDATA    =</span><br><span class="line">*       MATERIALDATA     =</span><br><span class="line">        TAXDATA          = LT_TAXDATA</span><br><span class="line">*       WITHTAXDATA      =</span><br><span class="line">*       VENDORITEMSPLITDATA       =</span><br><span class="line">        RETURN           = LT_RETURN</span><br><span class="line">*       EXTENSIONIN      =</span><br><span class="line">*       EXTENSIONOUT     =</span><br><span class="line">*       TM_ITEMDATA      =</span><br><span class="line">      .</span><br><span class="line">    LOOP AT LT_RETURN WHERE TYPE CA &#x27;EAX&#x27;.</span><br><span class="line">      LV_MESSAGE = LV_MESSAGE &amp;&amp; LT_RETURN-MESSAGE &amp;&amp; &#x27;；&#x27;.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    IF SY-SUBRC NE 0.</span><br><span class="line">      COMMIT WORK AND WAIT.</span><br><span class="line">      LV_MESSAGE = |创建成功；|.</span><br><span class="line">      LV_ICON = ICON_LED_GREEN.</span><br><span class="line">    ELSE.</span><br><span class="line">      ROLLBACK WORK.</span><br><span class="line">      LV_ICON = ICON_LED_RED.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    LOOP AT GT_RBKP_DATA INTO GS_RBKP_DATA WHERE BOX = &#x27;X&#x27; AND LIFNR = LS_ONLY-LIFNR AND BELNR IS INITIAL.</span><br><span class="line">      CLEAR:GS_RBKP_DATA-CELLTAB.</span><br><span class="line">      PERFORM FRM_SET_EDIT USING GS_RBKP_DATA.</span><br><span class="line">      GS_RBKP_DATA-ICON = LV_ICON.</span><br><span class="line">      GS_RBKP_DATA-MSG = LV_MESSAGE.</span><br><span class="line">      GS_RBKP_DATA-BELNR = LV_INVOICEDOCNUMBER.</span><br><span class="line">      GS_RBKP_DATA-GJAHR = LV_FISCALYEAR.</span><br><span class="line">      MODIFY GT_RBKP_DATA FROM GS_RBKP_DATA.</span><br><span class="line">    ENDLOOP.</span><br><span class="line">  ENDLOOP.</span><br><span class="line">ENDFORM.</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">FORM FRM_SAVE_FOR_CHANGE .</span><br><span class="line">  DATA: LS_HEADERDATA          TYPE BAPI_INCINV_DETAIL_HEADER,</span><br><span class="line">        LS_ADDRESSDATA         TYPE BAPI_INCINV_DETAIL_ADDRESSDATA,</span><br><span class="line">        LV_INVOICEDOCNUMBER    TYPE BAPI_INCINV_FLD-INV_DOC_NO,</span><br><span class="line">        LV_FISCALYEAR          TYPE BAPI_INCINV_FLD-FISC_YEAR,</span><br><span class="line">        LT_ITEMDATA            TYPE TABLE OF BAPI_INCINV_DETAIL_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_ITEMDATA_CHANGE     TYPE TABLE OF BAPI_INCINV_CREATE_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_ACCOUNTINGDATA      TYPE TABLE OF BAPI_INCINV_CREATE_ACCOUNT WITH HEADER LINE,</span><br><span class="line">        LT_GLACCOUNTDATA       TYPE TABLE OF BAPI_INCINV_CREATE_GL_ACCOUNT WITH HEADER LINE,</span><br><span class="line">        LT_MATERIALDATA        TYPE TABLE OF BAPI_INCINV_CREATE_MATERIAL WITH HEADER LINE,</span><br><span class="line">        LT_TAXDATA             TYPE TABLE OF BAPI_INCINV_DETAIL_TAX WITH HEADER LINE,</span><br><span class="line">        LT_TAXDATA_CHANGE      TYPE TABLE OF BAPI_INCINV_CREATE_TAX WITH HEADER LINE,</span><br><span class="line">        LT_WITHTAXDATA         TYPE TABLE OF BAPI_INCINV_CREATE_VENDORSPLIT WITH HEADER LINE,</span><br><span class="line">        LT_VENDORITEMSPLITDATA TYPE TABLE OF BAPI_INCINV_CREATE_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_RETURN              TYPE TABLE OF BAPIRET2 WITH HEADER LINE,</span><br><span class="line">        LT_EXTENSIONIN         TYPE TABLE OF BAPI_INCINV_CREATE_TM_ITEM WITH HEADER LINE,</span><br><span class="line">        LT_TM_ITEMDATA         TYPE TABLE OF /NFM/BAPIDOCITM WITH HEADER LINE,</span><br><span class="line">        LV_WRBTR               TYPE BAPIWRBTR,</span><br><span class="line">        LT_FTAXP               TYPE TABLE OF FTAXP,</span><br><span class="line">        LV_ITEM                TYPE  RBLGP,</span><br><span class="line">        LV_STATUS              TYPE CHAR01,</span><br><span class="line">        LV_ICON                TYPE CHAR04,</span><br><span class="line">        LV_MESSAGE             TYPE STRING.</span><br><span class="line"> </span><br><span class="line">  DATA: LS_TABLE_CHANGE       TYPE BAPI_INCINV_CHNG_TABLES,</span><br><span class="line">        LS_HEADERDATA_CHANGE  TYPE  BAPI_INCINV_CHNG_HEADER,</span><br><span class="line">        LS_HEADERDATA_CHANGEX TYPE  BAPI_INCINV_CHNG_HEADERX.</span><br><span class="line"> </span><br><span class="line">  DATA(LT_ONLY) = GT_RBKP_DATA.</span><br><span class="line"> </span><br><span class="line">  DELETE LT_ONLY WHERE BOX IS INITIAL OR BELNR IS INITIAL.</span><br><span class="line"> </span><br><span class="line">  SORT LT_ONLY BY GJAHR BELNR.</span><br><span class="line">  DELETE ADJACENT DUPLICATES FROM LT_ONLY COMPARING GJAHR BELNR.</span><br><span class="line"> </span><br><span class="line">  &quot; 数据校验</span><br><span class="line">  LOOP AT LT_ONLY INTO DATA(LS_ONLY).</span><br><span class="line">    CLEAR:LV_STATUS.</span><br><span class="line">    IF LS_ONLY-RBSTAT = &#x27;5&#x27;.</span><br><span class="line">      LV_STATUS = &#x27;E&#x27;.</span><br><span class="line">      GS_RBKP_DATA-ICON = ICON_LED_RED.</span><br><span class="line">      GS_RBKP_DATA-MSG = &#x27;凭证已过账，无法修改；&#x27;.</span><br><span class="line">      MODIFY GT_RBKP_DATA FROM GS_RBKP_DATA TRANSPORTING ICON MSG WHERE BOX = &#x27;X&#x27; AND GJAHR = LS_ONLY-GJAHR AND BELNR = LS_ONLY-BELNR.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    CALL FUNCTION &#x27;BAPI_INCOMINGINVOICE_GETDETAIL&#x27;</span><br><span class="line">      EXPORTING</span><br><span class="line">        INVOICEDOCNUMBER = LS_ONLY-BELNR</span><br><span class="line">        FISCALYEAR       = LS_ONLY-GJAHR</span><br><span class="line">      IMPORTING</span><br><span class="line">        HEADERDATA       = LS_HEADERDATA</span><br><span class="line">*       ADDRESSDATA      =</span><br><span class="line">      TABLES</span><br><span class="line">        ITEMDATA         = LT_ITEMDATA</span><br><span class="line">*       ACCOUNTINGDATA   =</span><br><span class="line">*       GLACCOUNTDATA    =</span><br><span class="line">*       MATERIALDATA     =</span><br><span class="line">        TAXDATA          = LT_TAXDATA</span><br><span class="line">*       WITHTAXDATA      =</span><br><span class="line">*       VENDORITEMSPLITDATA       =</span><br><span class="line">        RETURN           = LT_RETURN</span><br><span class="line">*       EXTENSIONOUT     =</span><br><span class="line">*       TMDATA           =</span><br><span class="line">*       NFMETALLITMS     =</span><br><span class="line">      .</span><br><span class="line"> </span><br><span class="line">    CASE LS_ONLY-TYPE+0(1).</span><br><span class="line">      WHEN &#x27;1&#x27; OR &#x27;3&#x27;.</span><br><span class="line">        LS_HEADERDATA-INVOICE_IND = &#x27;X&#x27;.</span><br><span class="line">      WHEN &#x27;2&#x27; OR &#x27;4&#x27;.</span><br><span class="line">        LS_HEADERDATA-INVOICE_IND = SPACE.</span><br><span class="line">      WHEN OTHERS.</span><br><span class="line">    ENDCASE.</span><br><span class="line"> </span><br><span class="line">    LS_HEADERDATA_CHANGE-DOC_DATE = LS_ONLY-BLDAT. &quot;凭证日期</span><br><span class="line">    LS_HEADERDATA_CHANGE-PSTNG_DATE = LS_ONLY-BUDAT. &quot;过账日期</span><br><span class="line">    LS_HEADERDATA_CHANGE-BLINE_DATE = LS_ONLY-ZFBDT.  &quot;基准日期</span><br><span class="line">    LS_HEADERDATA_CHANGE-DIFF_INV = LS_ONLY-LIFNR.  &quot;供应商</span><br><span class="line">    LS_HEADERDATA_CHANGE-REF_DOC_NO = LS_ONLY-XBLNR. &quot; 参考</span><br><span class="line">    LS_HEADERDATA_CHANGE-HEADER_TXT = LS_ONLY-BKTXT. &quot; 抬头文本</span><br><span class="line">    LS_HEADERDATA_CHANGE-GROSS_AMOUNT = LS_ONLY-RMWWR. &quot; 总金额</span><br><span class="line">    LS_HEADERDATA_CHANGE-CALC_TAX_IND = LS_ONLY-CAL_IND. &quot; 自动计算税额</span><br><span class="line"> </span><br><span class="line">    LS_HEADERDATA_CHANGEX-DOC_DATE = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-PSTNG_DATE = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-BLINE_DATE = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-DIFF_INV = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-REF_DOC_NO = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-HEADER_TXT = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-GROSS_AMOUNT = &#x27;X&#x27;.</span><br><span class="line">    LS_HEADERDATA_CHANGEX-CALC_TAX_IND = &#x27;X&#x27;.</span><br><span class="line">    LOOP AT LT_ITEMDATA.</span><br><span class="line">      READ TABLE GT_RBKP_DATA INTO GS_RBKP_DATA WITH KEY BOX = &#x27;X&#x27; EBELN = LT_ITEMDATA-PO_NUMBER EBELP = LT_ITEMDATA-PO_ITEM.</span><br><span class="line">      IF SY-SUBRC = 0.</span><br><span class="line">        LT_ITEMDATA-ITEM_AMOUNT = GS_RBKP_DATA-WRBTR. &quot; 金额</span><br><span class="line">        LT_ITEMDATA-QUANTITY = GS_RBKP_DATA-MENGE.</span><br><span class="line">        LT_ITEMDATA-TAX_CODE = GS_RBKP_DATA-MWSKZ.</span><br><span class="line">        LT_ITEMDATA-ITEM_TEXT = GS_RBKP_DATA-SGTXT. &quot; 文本</span><br><span class="line">      ENDIF.</span><br><span class="line">      LT_ITEMDATA-ITEM_AMOUNT = ABS( LT_ITEMDATA-ITEM_AMOUNT ).</span><br><span class="line">      IF LS_HEADERDATA-INVOICE_IND NE &#x27;X&#x27;.</span><br><span class="line">        LT_ITEMDATA-ITEM_AMOUNT = LT_ITEMDATA-ITEM_AMOUNT * -1.</span><br><span class="line">      ENDIF.</span><br><span class="line">      CASE LS_ONLY-TYPE+0(1).</span><br><span class="line">        WHEN &#x27;1&#x27; OR &#x27;2&#x27;.</span><br><span class="line">          LT_ITEMDATA-DE_CRE_IND  = SPACE.</span><br><span class="line">        WHEN &#x27;3&#x27; OR &#x27;4&#x27;.</span><br><span class="line">          LT_ITEMDATA-DE_CRE_IND = &#x27;X&#x27;.</span><br><span class="line">        WHEN OTHERS.</span><br><span class="line">      ENDCASE.</span><br><span class="line">      CLEAR:LT_ITEMDATA_CHANGE.</span><br><span class="line">      MOVE-CORRESPONDING LT_ITEMDATA TO LT_ITEMDATA_CHANGE.</span><br><span class="line">      APPEND LT_ITEMDATA_CHANGE.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    LT_TAXDATA_CHANGE-TAX_CODE = LS_ONLY-MWSKZ.</span><br><span class="line">    LT_TAXDATA_CHANGE-TAX_AMOUNT = LS_ONLY-WMWST1.</span><br><span class="line">    IF LS_ONLY-CAL_IND IS INITIAL.</span><br><span class="line">      APPEND LT_TAXDATA_CHANGE.</span><br><span class="line">      LS_TABLE_CHANGE-TAXDATA = &#x27;X&#x27;.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    LS_TABLE_CHANGE-ITEMDATA = &#x27;X&#x27;.</span><br><span class="line">    CALL FUNCTION &#x27;BAPI_INCOMINGINVOICE_CHANGE&#x27;</span><br><span class="line">      EXPORTING</span><br><span class="line">        INVOICEDOCNUMBER     = LS_ONLY-BELNR</span><br><span class="line">        FISCALYEAR           = LS_ONLY-GJAHR</span><br><span class="line">        INVOICE_DOC_STATUS   = &#x27;A&#x27;</span><br><span class="line">        TABLE_CHANGE         = LS_TABLE_CHANGE</span><br><span class="line">        HEADERDATA_CHANGE    = LS_HEADERDATA_CHANGE</span><br><span class="line">        HEADERDATA_CHANGEX   = LS_HEADERDATA_CHANGEX</span><br><span class="line">*       ADRESSDATA_CHANGE    =</span><br><span class="line">*       ADRESSDATA_CHANGEX   =</span><br><span class="line">      IMPORTING</span><br><span class="line">        INVOICEDOCNUMBER_NEW = LV_INVOICEDOCNUMBER</span><br><span class="line">        FISCALYEAR_NEW       = LV_FISCALYEAR</span><br><span class="line">      TABLES</span><br><span class="line">        ITEMDATA             = LT_ITEMDATA_CHANGE</span><br><span class="line">*       ACCOUNTINGDATA       =</span><br><span class="line">*       GLACCOUNTDATA        =</span><br><span class="line">*       MATERIALDATA         =</span><br><span class="line">        TAXDATA              = LT_TAXDATA_CHANGE</span><br><span class="line">*       WITHTAXDATA          =</span><br><span class="line">*       VENDORITEMSPLITDATA  =</span><br><span class="line">        RETURN               = LT_RETURN</span><br><span class="line">*       EXTENSIONIN          =</span><br><span class="line">*       TM_ITEMDATA          =</span><br><span class="line">      .</span><br><span class="line"> </span><br><span class="line">    CLEAR:LV_MESSAGE.</span><br><span class="line">    LOOP AT LT_RETURN WHERE TYPE CA &#x27;EAX&#x27;.</span><br><span class="line">      LV_MESSAGE = LV_MESSAGE &amp;&amp; LT_RETURN-MESSAGE &amp;&amp; &#x27;；&#x27;.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    IF SY-SUBRC NE 0.</span><br><span class="line">      COMMIT WORK AND WAIT.</span><br><span class="line"> </span><br><span class="line">      LV_MESSAGE = |修改成功；|.</span><br><span class="line">      LV_ICON = ICON_LED_GREEN.</span><br><span class="line">    ELSE.</span><br><span class="line">      ROLLBACK WORK.</span><br><span class="line">      LV_ICON = ICON_LED_RED.</span><br><span class="line">    ENDIF.</span><br><span class="line"> </span><br><span class="line">    LOOP AT GT_RBKP_DATA INTO GS_RBKP_DATA WHERE BOX = &#x27;X&#x27; AND GJAHR = LS_ONLY-GJAHR AND BELNR = LS_ONLY-BELNR.</span><br><span class="line">      GS_RBKP_DATA-ICON = LV_ICON.</span><br><span class="line">      GS_RBKP_DATA-MSG = LV_MESSAGE.</span><br><span class="line">      MODIFY GT_RBKP_DATA FROM GS_RBKP_DATA.</span><br><span class="line">    ENDLOOP.</span><br><span class="line">  ENDLOOP.</span><br><span class="line"> </span><br><span class="line">ENDFORM.</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FORM FRM_DELETE_ROW .</span><br><span class="line"> </span><br><span class="line">  DATA: LT_RETURN  TYPE TABLE OF BAPIRET2 WITH HEADER LINE,</span><br><span class="line">        LV_MESSAGE TYPE STRING.</span><br><span class="line"> </span><br><span class="line">  DATA(LT_ONLY) = GT_RBKP_DATA.</span><br><span class="line"> </span><br><span class="line">  DELETE LT_ONLY WHERE BOX IS INITIAL OR BELNR IS INITIAL.</span><br><span class="line"> </span><br><span class="line">  SORT LT_ONLY BY GJAHR BELNR.</span><br><span class="line">  DELETE ADJACENT DUPLICATES FROM LT_ONLY COMPARING GJAHR BELNR.</span><br><span class="line"> </span><br><span class="line">  LOOP AT LT_ONLY INTO DATA(LS_ONLY).</span><br><span class="line">    CALL FUNCTION &#x27;BAPI_INCOMINGINVOICE_DELETE&#x27;</span><br><span class="line">      EXPORTING</span><br><span class="line">        INVOICEDOCNUMBER = LS_ONLY-BELNR</span><br><span class="line">        FISCALYEAR       = LS_ONLY-GJAHR</span><br><span class="line">      TABLES</span><br><span class="line">        RETURN           = LT_RETURN.</span><br><span class="line"> </span><br><span class="line">    LOOP AT LT_RETURN WHERE TYPE CA &#x27;EAX&#x27;.</span><br><span class="line">      LV_MESSAGE = LV_MESSAGE &amp;&amp; LT_RETURN-MESSAGE &amp;&amp; &#x27;；&#x27;.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    IF SY-SUBRC NE 0.</span><br><span class="line">      COMMIT WORK AND WAIT.</span><br><span class="line">      DELETE GT_RBKP_DATA WHERE GJAHR = LS_ONLY-GJAHR AND BELNR = LS_ONLY-BELNR.</span><br><span class="line">    ELSE.</span><br><span class="line">      LOOP AT GT_RBKP_DATA INTO GS_RBKP_DATA WHERE BOX = &#x27;X&#x27; AND GJAHR = LS_ONLY-GJAHR AND BELNR = LS_ONLY-BELNR.</span><br><span class="line">        GS_RBKP_DATA-ICON = ICON_LED_RED.</span><br><span class="line">        GS_RBKP_DATA-MSG = LV_MESSAGE.</span><br><span class="line">        MODIFY GT_RBKP_DATA FROM GS_RBKP_DATA.</span><br><span class="line">      ENDLOOP.</span><br><span class="line">    ENDIF.</span><br><span class="line">  ENDLOOP.</span><br><span class="line">ENDFORM.</span><br></pre></td></tr></table></figure>
</li>
<li><p>过账</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">FORM FRM_DELETE_ROW .</span><br><span class="line"> </span><br><span class="line">  DATA: LT_RETURN  TYPE TABLE OF BAPIRET2 WITH HEADER LINE,</span><br><span class="line">        LV_MESSAGE TYPE STRING.</span><br><span class="line"> </span><br><span class="line">  DATA(LT_ONLY) = GT_RBKP_DATA.</span><br><span class="line"> </span><br><span class="line">  DELETE LT_ONLY WHERE BOX IS INITIAL OR BELNR IS INITIAL.</span><br><span class="line"> </span><br><span class="line">  SORT LT_ONLY BY GJAHR BELNR.</span><br><span class="line">  DELETE ADJACENT DUPLICATES FROM LT_ONLY COMPARING GJAHR BELNR.</span><br><span class="line"> </span><br><span class="line">  LOOP AT LT_ONLY INTO DATA(LS_ONLY).</span><br><span class="line">    CALL FUNCTION &#x27;BAPI_INCOMINGINVOICE_POST&#x27;</span><br><span class="line">      EXPORTING</span><br><span class="line">        INVOICEDOCNUMBER = LS_ONLY-BELNR</span><br><span class="line">        FISCALYEAR       = LS_ONLY-GJAHR</span><br><span class="line">      TABLES</span><br><span class="line">        RETURN           = LT_RETURN.</span><br><span class="line"> </span><br><span class="line">    LOOP AT LT_RETURN WHERE TYPE CA &#x27;EAX&#x27;.</span><br><span class="line">      LV_MESSAGE = LV_MESSAGE &amp;&amp; LT_RETURN-MESSAGE &amp;&amp; &#x27;；&#x27;.</span><br><span class="line">    ENDLOOP.</span><br><span class="line"> </span><br><span class="line">    IF SY-SUBRC NE 0.</span><br><span class="line">      COMMIT WORK AND WAIT.</span><br><span class="line">      </span><br><span class="line">    ELSE.</span><br><span class="line"> </span><br><span class="line">    ENDIF.</span><br><span class="line">  ENDLOOP.</span><br><span class="line">ENDFORM.</span><br></pre></td></tr></table></figure>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>&#x2F;</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/20/%E5%85%A5%E5%BA%93%E4%BA%A7%E9%87%8F%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/20/%E5%85%A5%E5%BA%93%E4%BA%A7%E9%87%8F%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">入库产量逻辑梳理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-20 21:07:02 / 修改时间：22:37:11" itemprop="dateCreated datePublished" datetime="2022-11-20T21:07:02+08:00">2022-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">业务学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>这个需求实际是为了梳理公司的产量逻辑，目前的产量存在主要以下几个问题：</p>
<ol>
<li>各个部门对产量的定义不一致，导致对产量的叫法不一致，可能会有生产产量、运营产量、绩效产量等等。</li>
<li>2个系统之间的对产量的定义不一致，导致产量的出数不一致，同时也导致了手工表的存在，主要在于第一个是跨月问题，ECP定义的产量是冷硬的结束时间，而ECP往SAP推送的是质检完成的入库时间。所以导致2个数据不一致。就是因为这个数据不一致导致了过去10个月财务按照SAP系统结账，但是按照保管给的手工账进行分析。这是一个非常严重的问题。</li>
<li>SAP与ECP定位模糊，导致产量的数据应该从SAP出还是从ECP出大家都搞不清楚，从而导致BI取数不知道从那个系统取出。</li>
</ol>
<p>因此，在10月份，11月份，分别拉齐了生产、财务管理层梳理产量的定义。<br>会议确定：<br>产量分为入库产量、生产产量、绩效产量3部分，其中入库产量的定义是进入产成品库的数量。由于目前是SAP中管理库存，所以入库产量是从SAP系统中取出，并且入库的产量按照每月的实际入库产量为主，如果发生跨月消耗的话，记录负值在本月，过往月份的产量不动。</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>在目前的入库产量里区分为酸洗产量和冷硬产量，酸洗的特殊情况不算多，基本就分为正常酸洗和酸洗反洗，而且量非常的少；但是冷硬的情况比较多一些，根据生产过程分为入库、入库冲销、物料转换、重轧、重卷、分卷等多种情况，并各种不同情况可以进行混杂，先入库、再冲销、再入库，继续物料转换，物料转换完成后重卷、分卷。类似这种情况非常多。</p>
<p>那么怎么计算入库产量？<br>刚开始的时候第一个想法就是去ZMM006里取所有的入库的数据，根据物料、卷号、批次号来找出各种情况，比如冲销的、309的、重卷的、多次重卷或重轧的。而且针对重卷这种多种情况还和杨总设计了一种算法逻辑，就是根据父卷去找子卷，一直找到最后一个子卷，然后一级级的往上减，这样的话就能实现在每个月里的产量都是一致的。<br>这个逻辑出来了，但是通过和保管数据核对，发现ZMM006报表里面本身的计算逻辑就有纰漏，本身就没有包含所有的逻辑，所以我们从ZMM006里取到的值根本不对，源数据就不对了，所以再做多少加工都白搭。</p>
<p>ZMM006不行，只能从底表查，底表的话基于物料的移动就是MSEG，因为MB51的查询底表就是MSEG，MSEG里有移动类型、批次、物料、工厂、库存地，所以我们就可以依据这个表查询出基于101收货，261投料、309物料转换、102冲销的移动类型。并且针对261、102的计算为负值。这样的好处是：首先我们查询的是产成品库</p>
<ol>
<li>正常的生产：就是只有一个101，产成品入库</li>
<li>重卷、改轧的生产：首先101入库，然后261领料，这样就会有2条，然后产出的产品又会新增一条101入库。以此类推。</li>
<li>正常生产后冲销的：101入口后直接一个102冲销，这样合计下来就是正确的入库量。</li>
<li>309转换的，直接新增一条309转换的量。<br>因为MSEG只有物料、批次和移动类型，所以计算入库产量的时候异常的简单，只需要根据过账日期明确出不同的移动类型，然后加减就能得到每个卷的真实入库产量。</li>
</ol>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>接到需求后，尤其是之前实施都没有思考的需求，千万不要思维定势，而是要抓住问题的根本，这样的才能少走弯路，起码在ZMM006上至少浪费了4天的时间。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/15/%E8%87%B4%E8%BF%9COA%E4%B8%8E%E5%8C%97%E6%A3%AE%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/15/%E8%87%B4%E8%BF%9COA%E4%B8%8E%E5%8C%97%E6%A3%AE%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/" class="post-title-link" itemprop="url">致远OA与北森组织架构同步</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-15 19:07:02 / 修改时间：19:55:48" itemprop="dateCreated datePublished" datetime="2022-11-15T19:07:02+08:00">2022-11-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%B4%E8%BF%9COA/" itemprop="url" rel="index"><span itemprop="name">致远OA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>需求是致远OA完成与北森HR的数据组织架构同步，包括集团、单位、部门、职务、岗位、人员信息。北森本身有以上信息的接口，然后致远OA中组织架构同步的方式分别有CTP开发平台进行而开，CIP平台进行应用集成。</p>
<p>目前我们使用的是CIP应用集成的方式进行。CIP集成的方式又分为中间表、视图、接口方式，当前我们使用中间表方式。利用此方式的原因是刚完成北森HR与BI系统的同步，可以直接使用kettle的任务来进行数据的抽取，加工后直接进中间表后即可。</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="1-北森HR接口"><a href="#1-北森HR接口" class="headerlink" title="1. 北森HR接口"></a>1. 北森HR接口</h3><p>北森HR中接口主要包含以下几个（在北森开放平台中都能查到）：<br>0. 拿token接口<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/token">https://openapi.italent.cn/token</a></p>
<ol>
<li><p>读取组织接口：<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/TenantBaseExternal/api/v5/Organization/GetByTimeWindow">https://openapi.italent.cn/TenantBaseExternal/api/v5/Organization/GetByTimeWindow</a></p>
</li>
<li><p>读取部门接口（和组织相同）：<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/TenantBaseExternal/api/v5/Organization/GetByTimeWindow">https://openapi.italent.cn/TenantBaseExternal/api/v5/Organization/GetByTimeWindow</a></p>
</li>
<li><p>读取职务接口：<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/TenantBaseExternal/api/v5/JobPost/GetByTimeWindow">https://openapi.italent.cn/TenantBaseExternal/api/v5/JobPost/GetByTimeWindow</a></p>
</li>
<li><p>读取职位接口：<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/TenantBaseExternal/api/v5/Position/GetByTimeWindow">https://openapi.italent.cn/TenantBaseExternal/api/v5/Position/GetByTimeWindow</a> </p>
</li>
<li><p>读取人员接口：<br><a target="_blank" rel="noopener" href="https://openapi.italent.cn/TenantBaseExternal/api/v5/Employee/GetEmployeeOfOrganization">https://openapi.italent.cn/TenantBaseExternal/api/v5/Employee/GetEmployeeOfOrganization</a></p>
</li>
</ol>
<h3 id="2-致远OA平台（版本V8-1SP2集团版）"><a href="#2-致远OA平台（版本V8-1SP2集团版）" class="headerlink" title="2.致远OA平台（版本V8.1SP2集团版）"></a>2.致远OA平台（版本V8.1SP2集团版）</h3><ol>
<li>首先登录系统管理员，并切换集团管理员账号，只有集团管理员才有权限操作CIP集成。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115192357.png" alt="20221115192357"></li>
</ol>
<p>进入组织同步菜单。</p>
<p>进入后需要进行组织同步的方案设置，在设置之前需要先注册第三方应用（在主数据同步的上面菜单），进行产品登记和产品注册。产品登记和产品注册没什么好说的，只是根据第三方系统的信息提交下，全部是手工填报。</p>
<p>组织同步步骤：</p>
<ol>
<li><p>同步方案设置<br>第一次首先进行同步的方案创建，这里我们主要是选中间表，配置好数据库连接地址，基本是在OA库里就可以。然后如果没有中间表可以点击创建中间库，这样系统会自动创建mid开头的中间表。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115192810.png" alt="20221115192810"><br>如图所示，点击确定。</p>
</li>
<li><p>同步初始化<br>新建同步的详细设置，主要就是是集团匹配还是单位匹配，我们这里直接就选择集团匹配。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115192956.png" alt="20221115192956"><br>把所有的勾都打上。</p>
</li>
<li><p>同步操作<br>这里就是可以手工执行同步的方案，直接跑数据<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115193101.png" alt="20221115193101"><br>也可以定时同步数据，考虑服务器压力和HR中人员岗位调整后对表单的影响，不建议设置定时自动跑数据。</p>
</li>
<li><p>同步日志<br>第3步执行结束后会弹窗跳转日志页面，也可以手工点日志页面，主要展现同步的情况。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115193234.png" alt="20221115193234"></p>
</li>
</ol>
<p>至此OA层面上的操作完成，同步的逻辑是如果系统中已经存在人员，第一次同步会把所有人员信息失效，然后需要再跑一次然后就可以同步正确的组织架构信息了。这里能够同步组织架构的前提是中间表里已经有了正确的数据，所以我们需要第三步，定时从kettle中取数。</p>
<p>** 这里还需要注意致远里的中间表的取值问题 **<br>这里中间表的取值需要参考致远开放平台的组织架构中间表取值逻辑。具体连接如下。<br><a target="_blank" rel="noopener" href="http://open.seeyon.com/book/ji-cheng-zu-jian/zhu-shu-ju-tong-bu/tong-bu-she-zhi.html?h=%E7%BB%84%E7%BB%87%E5%90%8C%E6%AD%A5">http://open.seeyon.com/book/ji-cheng-zu-jian/zhu-shu-ju-tong-bu/tong-bu-she-zhi.html?h=%E7%BB%84%E7%BB%87%E5%90%8C%E6%AD%A5</a> </p>
<h3 id="3-KETTLE取值到中间表"><a href="#3-KETTLE取值到中间表" class="headerlink" title="3.KETTLE取值到中间表"></a>3.KETTLE取值到中间表</h3><ol>
<li>KETTLE任务整体概览：<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115193844.png" alt="20221115193844"><br>这里是做了一个job，然后进行token获取、读取组织、部门等等一系列的操作，而且当前面任务失败时不进行后面的流转。同时做了定时设置，固定时间内进行数据抽取。</li>
<li>具体job操作<br>2.1 获取TOKEN<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115194134.png" alt="20221115194134"><br>2.2 读取组织<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115194158.png" alt="20221115194158"><br>这里的读取组织是读取GP控股下所有的子公司和部门，保持和北森HR中的一致性。同时这里也用了一个循环，确保在组织读取完成以后正常结束任务。<br>2.2.3 写入组织<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115194353.png" alt="20221115194353"><br>这里是读取组织中的转换任务，进入后可以读取我们想要的组织并进行过滤和写入中间表。<br>2.3 读取人员，KETTLE任务中其余的和读取组织都大同小异，区别就是URL的不同，但是在人员中需要关联部门表并进行group_id的写死，如下：<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221115194648.png" alt="20221115194648"></li>
</ol>
<p>整体KETTLE任务的目的就是参照致远开放平台对中间表各个字段的定义和要求，通过北森HR的接口利用各种手段拼接起来并插入中间库的过程。</p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>这个需求本来没打算接，但是没谈拢所以又落在我手里，实现需求的方式有2个，二开和CIP，二开的成本和时间要求太高，供应商也没有使用CIP平台做过这种集成，而且时间要求比较紧张，所以仓促上来导致开始没想好对接的方案，也是逐渐在做的过程中理清了思路。目前通过这种方式能够很好的实现组织架构的同步。<br>在这个过程中最难不是技术的实现，而是方案的确定，尤其是这种闭源系统，只有开放平台和后台的知识文档，这样的话就只能去扒开放平台的知识和尽量的咨询外部实现过类似方案的顾问。在实施公司明确说没有做过类似需求的情况下，咨询外部顾问聊确定能够集成，这也给了我坚持往下做的信心。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/20/Kettle%E5%AE%9E%E6%88%98%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/20/Kettle%E5%AE%9E%E6%88%98%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">Kettle实战学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-20 18:46:00 / 修改时间：20:33:08" itemprop="dateCreated datePublished" datetime="2022-10-20T18:46:00+08:00">2022-10-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">数据</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="实现目标"><a href="#实现目标" class="headerlink" title="实现目标"></a>实现目标</h3><p>实现的目标是获取钉钉系统里所有日志信息，并写入数据库</p>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>使用kettle请求钉钉日志接口，解析获取到的json结构，然后写入数据库。由于钉钉日志接口最大每次获取20个人记录，所以还需要根据关键字段判断是否需要继续执行，直到执行完毕。<br>这里要注意的是kettle里只有作业才可以执行循环，转换不能执行循环作业。</p>
<h3 id="具体思路"><a href="#具体思路" class="headerlink" title="具体思路"></a>具体思路</h3><p><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020201351.png" alt="20221020201351"></p>
<p>先拖一个start，默认的组件，然后设置变量，这里的变量是has_more 和 zcursor，主要的作用是has_more查询是否还有下一条记录。zcursor是下一条记录的游标字段。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020201623.png" alt="20221020201623"></p>
<p>其次，获取token，获取token写了一个转换任务。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020201747.png" alt="20221020201747"></p>
<ol>
<li><p>先构造参数，将获取token中的url、body、method等关键字段先进行定义。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020201841.png" alt="20221020201841"></p>
</li>
<li><p>直接用rest组件根据构造参数里变量进行定义<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020201923.png" alt="20221020201923"></p>
</li>
<li><p>直接用json组件，根据路径获取返回的token结果<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020202000.png" alt="20221020202000"></p>
</li>
<li><p>把拿到的token放到全局变量中，方便后面的job作业使用<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020202030.png" alt="20221020202030"></p>
</li>
</ol>
<p>token获取完毕后进入脚本验证，这里的脚本验证是判断has_more的变量是否发生了改变，然后根据判断条件是否进入循环和结束。在这个节点后面红色线条指向结束，即当判断条件为false的情况下结束，绿色线条指向循环，意思是当判断条件为true时进入循环。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020202320.png" alt="20221020202320"></p>
<p>如果判断条件为false直接进入结束组件。</p>
<p>如果判断条件为true进入循环组件。循环组件中定义了一个请求日志的转换，然后定义一个dummy组件。由于循环只能是最少3个组件间循环，所以需要一个dummy组件来填补。</p>
<p>请求日志转换任务：<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020202858.png" alt="20221020202858"></p>
<ol>
<li><p>拖一个生成记录<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020202923.png" alt="20221020202923"></p>
</li>
<li><p>拼接js脚本，形成请求的记录<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020203006.png" alt="20221020203006"></p>
</li>
<li><p>restful接口请求<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020203101.png" alt="20221020203101"></p>
</li>
<li><p>解析json结果，一层层的解析结果，并拆出多条记录<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020203144.png" alt="20221020203144"></p>
</li>
<li><p>拉一个表输出，输出到数据库<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20221020203233.png" alt="20221020203233"></p>
</li>
</ol>
<p>kettle接口完成，然后部署到服务器上，最后设一个定时任务，完成。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/04/%E6%9C%9F%E8%B4%A7%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/04/%E6%9C%9F%E8%B4%A7%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">期货业务学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-04 17:00:00" itemprop="dateCreated datePublished" datetime="2022-10-04T17:00:00+08:00">2022-10-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-13 20:13:45" itemprop="dateModified" datetime="2022-10-13T20:13:45+08:00">2022-10-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">业务学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-什么是头寸？"><a href="#1-什么是头寸？" class="headerlink" title="1. 什么是头寸？"></a>1. 什么是头寸？</h3><p>在期货中，把买进期货合约做多者称为多头，卖出期货合约做空者称为空头。 多头是指投资者对期货市场看好，预计期货合约的价格将会上涨，于是趁低价买进期货合约，待价格上涨后再卖出以获得差额收益；相反，空头就是对未来期货价格看跌，而卖出期货合约，待价格下跌后再买进以获得差额收益。那期货头寸是什么呢？头寸也叫“部位”（position），是指期货投资者持有的仓位，即未进行对冲处理的买或卖期货合约数量。对做多者，称处于多头头寸；对做空者，称处于空头头寸。多单与空单的差值，称为“净头寸”。</p>
<h3 id="2-什么是点价？"><a href="#2-什么是点价？" class="headerlink" title="2. 什么是点价？"></a>2. 什么是点价？</h3><p>点价我知道原来在大豆进出口贸易有这个概念。美国是最大的大豆出口国，我国是最大的大豆进口国。大豆价格波动很大，这个交易涉及到三方，美国农民、美国贸易商、中国油厂。美国农民通过点价卖货的方式把大豆卖给贸易商，即卖出后并不确定卖出价，而是相对某月期货确定一个升贴水，农民可自行选择一定期限内约定期货的价格，再计算上升贴水就是农民获得的售货款。中国油厂点价买货则是接受贸易商的升贴水报价，签订进口合同时，并不直接确定大豆的价格，在合同中约定以CBOT某月大豆合约作为标的合约，在一定期限内 以期货价格均价加升贴水作为最终的进口价格。而贸易商在中间则是利用期货套期保值的功能，达到低风险交易的目的。<br>具体分三步：<br>第一步：贸易商向农民收购大豆，同时在期货市场卖出相应期货保值，手中持有大豆现货多头和相应期货空头；<br>第二步：向中国油厂报升贴水价格，并与之签订合同，中国油厂接受升贴水报价，并在一定期限内购买相应数量的期货（即中国油厂点价）<br>第三步：中国油厂将期货多单转给贸易商，贸易商平提手中的期货空头，同时中国油厂从贸易商手中购买相应数量的大豆现货，过程完成后，贸易商手中的大豆现货多头和期货空头同时平仓。<br>最初大豆交易并非用的点价方式，但有几年大豆价格跌的厉害，大豆在运送过程中，比如40天，价格大跌，船到港后，大豆购买方宁愿不要保证金也要违约，贸易商损失惨重，而在大豆价格大幅上涨时，这一情形又反过来。反正渐渐的，大豆就使用点价交易了。另外，感觉中国大豆的进口史也是有挺多值得细细说一说的。</p>
<h3 id="3-什么是正套、反套？"><a href="#3-什么是正套、反套？" class="headerlink" title="3. 什么是正套、反套？"></a>3. 什么是正套、反套？</h3><p>近有很多交易者问我关于套利的事情，我发现很多交易者甚至连正套和反套都不是很理解，也有的人是死记硬背、生搬硬套，所以今天我们来一起了解一下正套和反套。<br>我从以下三个角度来帮助你理解正反套：</p>
<ol>
<li>时间维度——跨期套利</li>
<li>产业链维度——产业套利</li>
<li>贸易流维度——跨市套利<br>首先，从跨期套利角度来讲。通常情况下，只有先拥有商品，才有对商品的卖出处置权。人们可以通过生产、采购甚至借贷现货来实现最终的卖出交割，这种符合商品正常流向的近期买入、远期卖出的套利方式，我们称之为正向套利。同样，由于时间的不可逆性，我们无法让未来的拥有来满足现在的需要，所以期货市场中近期卖出、远期买入的套利方式，我们称之为反向套利。</li>
</ol>
<p>其次，从产业套利角度来讲。在产业套利当中，整个产业链分为原材料、产成品。产成品是由原材料生产和加工而来的，所以做多原料做空成品属于正向套利，反之，做空原料做多成品属于反向套利。我们以最常见的大豆产业链来说，做多大豆做空豆油豆粕属于正向套利，而做空大豆做多豆油豆粕就属于反向套利。</p>
<p>最后，从跨市套利角度来讲。在跨市场套利中，正向套利的意思是做多国外，做空国内。之所以称之为正向套利，原因在于中国是净进口国，净贸易流方向为国外到国内。正向套利的实物逻辑在于进口贸易流，做多国外同时做空国内，意味着从国外买入，再卖到国内，与贸易流方向一致。以棉花为例，国内棉花价格一直高于美棉的原因有两个：一是国内棉花种植的机械化程度不强，种植成本远超美国；二是中国和美国对棉花种植的扶持政策存在差异，美国直接补贴棉农，而国内则是通过发改委国储局的棉花收抛储政策来影响市场供给，进而维持价格稳定，达到保障棉农利益、调控国内棉价的双重目的。所以，每年我们国家都会从美国进口一部分棉花，贸易流是从美国流向中国，所以做多美棉，做空郑棉，这就属于跨市套利中的正向套利。当然，棉花和白糖这两个品种都是配额制的，在一定程度上会受政策的干预和影响。</p>
<h3 id="4-杨老师普及期货知识"><a href="#4-杨老师普及期货知识" class="headerlink" title="4. 杨老师普及期货知识"></a>4. 杨老师普及期货知识</h3><p>对于期货的开仓，就是开多和开空，然后平仓的时候就是平多和平空。<br>对于这个ZLYD&#x2F;XMD公司来说，有套期保值和套利2种方式。具体如下：<br>在梳理套期保值和套利之前首先要明确几个名词：<br>1、持仓：也可以叫头寸，就是你现在手头上的合约，比如持有202210的豆粕空单10手。<br>2、基差：现货和期货的价差，比如现货市场价5000，期货市场价5500，基差就是现货-期货 &#x3D; -500。<br>3、正套：买现货，卖期货，适用预期后面要涨的市场。<br>4、反套：卖现货，买期货，使用预期后面要降的市场。<br>5、套期保值：买现货的同时卖期货。</p>
<p><strong>正套</strong>：正套可以做套期保值也可以做套利。<br>正套主要的操作是买现货的时候开一个期货的空单，比如现货的价格是4000，期货的价格是4500，基差是-500。<br>那么当这笔货交货的时候现货的价格是4100，期货价格是4550，当前基差是-450。<br>这个时候我们可以平掉这个空单，那么基差就是-450 - （-500） &#x3D; 50。<br>我们在这笔交易中盈利50。</p>
<p><strong>反套</strong>：完全参考正套的方式，所有买卖操作全部相反。</p>
<p><strong>套期保值</strong>：套期保值主要用在采购中。<br>套期保值完全是作为采购保值的操作来做的，比如我们采购1000吨的卷，价格为4000，但是交期为3个月，那么我们就会担心3个月后价格跌了就会造成损失，那么我们就可以在期货市场中做一笔空单，卖出1000吨的货（100手，一般10吨为1手，豆粕、热卷、螺纹钢都是）价格为4100。<br>那么当我们1000吨的现货在3个月后入库后（比如3个月后直接全部入库，举例子，实际陆续入库的话对应期货操作是一样的），当前价格是3900，我们每吨赔了100，那么我们对应期货的价格可能跌倒了3990。那么我们就平掉期货的仓位，这个时候我们在现货中赔了100块，但是在期货市场中赚了110块，总体每吨赚10块。如果期货价格为4010，那么我们在现货中赔了100，但是在期货市场赚了90，总体每吨赔了10块钱。<br>所以套期保值可以锁定大部分的利润，明细的降低了价格的波动风险。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/06/SAP%E6%96%B0%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/06/SAP%E6%96%B0%E7%89%B9%E6%80%A7/" class="post-title-link" itemprop="url">SAP新特性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-06 08:32:52 / 修改时间：08:46:27" itemprop="dateCreated datePublished" datetime="2022-09-06T08:32:52+08:00">2022-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAP/" itemprop="url" rel="index"><span itemprop="name">SAP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>1、@的用法</strong><br>首先需要用@data(内表)定义需要输出的内表，这个内表必须是没有定义过的，其次，一定要注意在select语句中加逗号，最后在系统变量比如SY-LANGU前面也要加上@符号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">select kna1~kunnr,</span><br><span class="line">       kna1~name1,</span><br><span class="line">       KNA1~land1,</span><br><span class="line">       T005T~LANDX AS LANAM,</span><br><span class="line">       kna1~regio,</span><br><span class="line">       T005U~BEZEI AS PROVI,</span><br><span class="line">       kna1~ort01,</span><br><span class="line">       kna1~stras,</span><br><span class="line">       but000~BPEXT as bpcode,</span><br><span class="line">       &#x27;KH&#x27; AS BPLX</span><br><span class="line">  INTO TABLE @data(out_tab1)</span><br><span class="line">  FROM kna1</span><br><span class="line">  INNER JOIN T005T ON KNA1~LAND1 = T005T~LAND1 AND T005T~SPRAS = @SY-LANGU</span><br><span class="line">  INNER JOIN T005U ON KNA1~REGIO = T005U~BLAND AND KNA1~LAND1 = T005U~LAND1  AND T005U~SPRAS = @SY-LANGU</span><br><span class="line">  inner join but000 on kna1~kunnr = but000~partner</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2、move-corresponding 的新语法特性</strong><br>MOVE-CORRESPONDING ITAB_A TO ITAB_B.<br>隐式操作会把B清空，然后按字段名依次复制。</p>
<p>新语法：<br>1、MOVE-CORRESPONDING ITAB_A TO ITAB_B KEEPING TARGET LINES.</p>
<p>2、ITAB_B &#x3D; CORRESPONDING #( BASE ( ITAB_B ) ITAB_A ).<br>保留原数据，在此基础上根据对应字段添加。<br>PS:如果结构相同不如直接APPEND，但是APPEND只能根据顺序来，可能不会自动的根据字段来对应。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/14/%E8%B4%A2%E5%8A%A1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/14/%E8%B4%A2%E5%8A%A1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">财务业务学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-14 09:00:00" itemprop="dateCreated datePublished" datetime="2022-08-14T09:00:00+08:00">2022-08-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-22 11:28:08" itemprop="dateModified" datetime="2022-09-22T11:28:08+08:00">2022-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">业务学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="财务业务流程"><a href="#财务业务流程" class="headerlink" title="财务业务流程"></a>财务业务流程</h3><p>1、 一般来说在SAP里财务分为2大类，一个是财务会计FI，一个是成本会计CO。我们根据这2个方面来。<br>FI:<br>主要包含4部分，总账GL,应收AR,应付AP,资产AM。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814090927.png" alt="20220814090927"><br>主要模块<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814091245.png" alt="20220814091245"><br>业财一体<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814091318.png" alt="20220814091318"></p>
<p>2、借贷关系<br>采购流程的借贷关系<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814091401.png" alt="20220814091401"></p>
<p>生产流程借贷关系<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814091549.png" alt="20220814091549"></p>
<p>销售流程借贷关系<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220814091607.png" alt="20220814091607"></p>
<hr>
<h3 id="财务业务报表"><a href="#财务业务报表" class="headerlink" title="财务业务报表"></a>财务业务报表</h3><p>ZFI030:ZLYD财务管理报表<br>ZFI013:轧辊管理明细<br>ZFI007:往来余额：供应商、客户、员工余额表<br>ZFI006:XMD科目余额三栏账<br>FAGLL03H:总账科目预览</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/13/%E9%94%80%E5%94%AE%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/13/%E9%94%80%E5%94%AE%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">销售业务学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-13 17:00:00" itemprop="dateCreated datePublished" datetime="2022-08-13T17:00:00+08:00">2022-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-26 20:49:36" itemprop="dateModified" datetime="2022-09-26T20:49:36+08:00">2022-09-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%9A%E5%8A%A1%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">业务学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="销售业务流程"><a href="#销售业务流程" class="headerlink" title="销售业务流程"></a>销售业务流程</h3><p>1、客户主数据维护</p>
<p>由客服专员利用OCR工具将开票信息或者营业执照转换成文本进行整理核对后导入SAP系统，若客户为一般纳税人，则在SAP系统中经过天眼查验证，再完成SAP系统内创建过程，最后将客户基础信息下发至MDM系统，并存储MDM系统返回的BP编码；若客户非一般纳税人，将客户身份证号作为税号录入到SAP中，经SAP系统税号唯一性验证后，将客户基础信息下发至MDM系统，并存储MDM系统返回的BP编码；当客户信息变更时，客服专员在SAP系统内完成客户信息修改，并将客户全部基础信息下发至MDM系统的过程。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813172416.png" alt="20220813172416"></p>
<p>2、价格主数据维护</p>
<p>实现本月结算合同的结算以及下月结算合同指导价在SAP系统中的应用，需要销售专员在每月25日与原料采购专员确定本月邯邢价格及优惠政策后，按照SAP价格表模板在线下完成《LY结算价格表》与《SX结算价格表》的制作，经过销售经理、销售总监线下审核后，由销售专员将结算价格表录入到SAP中，首次导入后，销售专员后期的维护只需要将需要修改的引用到OA系统中完成修改后发起审批流程，审批通过后SAP价格生效的流程。</p>
<p>使用VK11或者ZSD020A进行批导<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813172753.png" alt="20220813172753"></p>
<p>3、原料备货申请<br>每月末根据当前运营库存和销售订单量，制定出下月的原料总需求，由销售专员在OA发起原料备货申请，经销售经理审批、原料采购专员确认后，自动将表单内容同步到SAP原料备货申请模块的过程；每月中随时产生原料变更与新需求时，销售专员在OA发起原料备货申请，对原先原料备货申请进行变更以及对新增原料需求申请的流程。</p>
<p>OA发起备货申请-&gt; MM采购计划。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813173049.png" alt="20220813173049"></p>
<p>4、销售合同制作&#x2F;修改<br>由客服专员在SAP中创建（或修改）并打印销售合同，并与客户完成销售合同签字盖章确认后，客服专员在SAP内提交销售合同，系统自动生成OA销售合同审批流程，经销售经理、销售总监、结算管理会计在OA系统审批完成后，销售合同在SAP内开始生效，客服专员将纸质合同进行存档的流程。<br>ZSD001<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813173339.png" alt="20220813173339"></p>
<p>OA销售合同<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813173534.png" alt="20220813173534"></p>
<p>5、欠款质押发货额度申请<br>客户提出需要使用欠款&#x2F;质押手续进行发货时，销售专员与客户对接，客户来我司签订欠款证明，销售专员将纸质欠款证明提交至各级审批人的同时，在SAP中进行欠款额度的维护，线上线下同步催办审批，经过销售总监、经营副总、总经理、董事长、结算管理会计审批完成在OA中同步通知财务总监后，欠款额度在SAP中生效的流程。<br>ZSD003<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813175110.png" alt="20220813175110"><br>OA单据<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813175136.png" alt="20220813175136"></p>
<p>6、分货流程<br>客服专员通过SAP对已产出成品不能按照正常订单进行分货，或者是无订单排产导致的合同号不存在的库存进行分货的业务，需要客服专员在SAP系统中将合同号匹配标注进行分货，合同号标注完成后通过客户微信提货群将每个客户的分货明细发至客户的流程。<br>ZSD002&#x2F;ZSD002A 创建发货单<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813175351.png" alt="20220813175351"></p>
<p>7、发货<br>客服专员通过微信接收客户的提货需求时，客户进行货款打款后将电子回单发至客服专员，客服专员在SAP系统中进行货款确认后制作发货订单，将客户需提的货物引入进发货订单并进行保存的同时，SAP系统对货款进行检查，若发生使用定金、质押、欠款进行发货时，发货订单需结算管理会计进行审核。发货订单保存并审核通过后，客服专员在发货订单中填入运输车辆车号进行发货的流程。<br>ZSD005，根据ZSD002中创建的发货单，推送OA审批<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813180254.png" alt="20220813180254"><br>OA单据<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813180358.png" alt="20220813180358"></p>
<p>8、出库<br>客服专员在发货订单中填入车号后，司机入厂后由装车组进行货物的称重与装车，称重过程中若重量与标签重量不符，则由保管在SAP系统中进行重量的修改，轧机生产人员打印标签后替换原标签；若标签规格与PDA货物规格不符，则由品管员打印标签并替换原标签。更改重量后由客服专员在原发货订单中重新引入货物信息，装车完成后司机出厂过磅，若磅差超出合理范围则司机需返回车间再次复称后进行出厂过磅，过磅完成后由门岗使用PDA进行扫码对货物进行核验，核验信息无误后司机完成发货出厂的流程。<br>主要是在ECP系统中跑流程，主要流程：<br>扫码登记进厂过磅-&gt;ECP记录空车毛重-&gt;PDA接受销售发货单-&gt;货物复称-&gt;核对信息-&gt;装车，PDA扫码提交-&gt;出厂过磅-&gt;核对磅差-&gt;PDA扫码并打印出门证-&gt;（协议车辆）收货工厂保管在出门证签字确认，司机拍照上传小程序-&gt;自动确认收入-&gt;结束。</p>
<p>9、销售补差<br>销售部某合同执行完成后，在发票开具前因在业务执行中产生的小卷优惠、购货优惠、质量异议、酸洗加工补料、酸洗运费结算、返利、降级品优惠、结算指导价调整、特殊优惠等需要对客户账户返款或扣款时，销售专员或客服专员需要在SAP系统中创建借贷项订单，经过销售经理、销售总监、经营副总、总经理、结算管理会计审核后，在系统内实现对客户账户余额在系统账中进行调整的流程。<br>ZSD009:政策补差&#x2F;ZSD010:其他补差<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813181217.png" alt="20220813181217"><br>OA单据<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813181311.png" alt="20220813181311"></p>
<p>10、发票开具<br>营销中心销售部销售合同执行结束后客服专员及销售专员在发起开票申请前先将开票资料：销售合同复印件、销售对账单、收货确认函、业务委托书准备完成，并完成结算对账单、收货确认函中客户的签字盖章。开票资料准备完成后交至税务会计进行审核，审核通过后客服或销售专员在SAP系统中发起开票申请的流程。<br>ZSD013:开票申请<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220813181624.png" alt="20220813181624"><br>ZSD032:开票申请<br>红票会推送OA系统，非红票直接审批，推送金税系统。</p>
<h3 id="销售业务其他流程"><a href="#销售业务其他流程" class="headerlink" title="销售业务其他流程"></a>销售业务其他流程</h3><p>1、冷硬客诉处理<br>2、红字发票开具<br>3、套筒押金退回<br>4、销售退货<br>5、虚拟退货<br>6、XX来料加工交货差异量付款<br>7、标签更改<br>8、销售部另用料销售<br>9、废料销售<br>10、外储调拨<br>11、销售运费付款<br>12、协议车辆保证金利息付款<br>13、运输事故处理<br>14、运输管理费收入<br>15、余款退回</p>
<h3 id="销售业务报表"><a href="#销售业务报表" class="headerlink" title="销售业务报表"></a>销售业务报表</h3><p>1、ZSD019:发货清单报表<br>2、ZSD023:信贷报表<br>3、ZSD027:销售补差报表<br>4、ZSD028:开票报表<br>5、ZSD030:合同报表<br>6、ZSD039:自行优惠报表，这个报表的主要作用是客户在本月已经提货，但是没有出结算价，并且没有进行补差的，应收会计根据这个表里的差值（已出的当月结算价）手工制作凭证冲减当月的销售收入，并在次月对该凭证进行冲销，走完补差流程，自动生成准确的收入凭证。<br>7、ZSD021:XMD销售定金报表<br>8、ZSD038:ZLYD销售定金管理报表<br>9、ZSD022:ZLYD利用XMD的地方进行的仓储操作，提供仓储服务，卷是别人家的卷，只提供场地进行存储；因为仓储业务采用了511移动类型的免费收货，所以在收货时并没有生成有效的入库凭证，所以需要创建借贷项订单，并根据借贷项订单开票。</p>
<p>ZSD022A:仓储入库，采用批导的方式进入，同时能查询到所有入库卷的信息（有无库存）。<br>ZSD022B:仓储货转，卷的所有人发生变化，操作卷的转入客户及转出客户。<br>ZSD022C:仓储提货，创建卷的提货单，并查看卷的费用情况，包括基本费用、超期费用、其他费用。<br>ZSD022D:仓储借贷项订单，付款后创建借贷项订单<br>ZSD022E:仓储开票，根据借贷项订单进行开票，并发送OA申请。</p>
<p>10、ZSD037:仓储库存表，查询XMD仓库里热卷的实时库存及仓储费用情况。<br>11、ZSD040:ZLYD销售补差报表，查询ZLYD补差明细。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/08/%E8%AE%B0%E8%87%B4%E8%BF%9COA%E7%B3%BB%E7%BB%9FDEE%E6%8C%82%E6%8E%89%E9%81%87%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="一骗树">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打螺丝闲暇的记录">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/08/%E8%AE%B0%E8%87%B4%E8%BF%9COA%E7%B3%BB%E7%BB%9FDEE%E6%8C%82%E6%8E%89%E9%81%87%E5%9D%91/" class="post-title-link" itemprop="url">记致远OA系统DEE挂掉遇坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-08 15:53:02" itemprop="dateCreated datePublished" datetime="2022-08-08T15:53:02+08:00">2022-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-09 15:15:22" itemprop="dateModified" datetime="2022-08-09T15:15:22+08:00">2022-08-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%B4%E8%BF%9COA/" itemprop="url" rel="index"><span itemprop="name">致远OA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>在2022年8月7号下午左右，致远OA所有任务调用都出现问题，所有的任务都出现操作异常的弹窗。<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220808155648.png" alt="20220808155648"></p>
<h2 id="问题查找"><a href="#问题查找" class="headerlink" title="问题查找"></a>问题查找</h2><p>1、尝试重启致远主服务、重启物理机均无效</p>
<p>2、查看线程日志发现是所有的dee任务都在运行中，如下所示：<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/20220808155803.png" alt="20220808155803"></p>
<p>3、通过咨询致远代老师，拿到了解决方案，有3种方案：<br>方案一：<br>1、停止OA服务<br>2、将A8\base\dee\data下除了dee.mv.db或dee.h2.db外的，其他2个文件（dee.trace.db、dee.lock.db）删除<br>3、删除A8\base\dee\history下所有文件（没有history文件夹则不用管这个）<br>4、重启OA，连接上dee数据库</p>
<p>备注：集群OA的话每个节点需要做一次上面的操作</p>
<p>方案二：<br>如果上述操作后还是看不到dee控制台的数据，则按如下操作：<br>1、停止OA服务<br>2、备份A8\base\dee\data文件夹，比如改名data为data-bak<br>3、新建一个名为data的空文件夹<br>4、删除A8\base\dee\history下所有文件（没有history文件夹则不用管这个）<br>5、重启OA<br>6、在A8\base\dee\drpHistory下找到日期最近的drp文件（2020-12-10.drp），在dee控制台部署一下即可</p>
<p>备注：集群OA的话每个节点需要做一次上面的操作</p>
<p>方案三：<br>如果上述操作后还不行，则如下操作：<br>1、如果有自己备份drp，或则有dee工具（包含所有OA的dee任务，则导出OA里的任务为drp包）<br>2、停止OA服务<br>3、备份A8\base\dee\data文件夹，比如改名data为data-bak<br>4、新建一个名为data的空文件夹<br>5、删除A8\base\dee\history下所有文件（没有history文件夹则不用管这个）<br>6、重启OA<br>7、导入drp即可</p>
<p>备注：集群OA的话每个节点需要做一次上面的操作</p>
<p>4、通过测试，方案二解决问题，但是所有的任务全部失效，从dee平台中重新导出一份到OA解决问题。</p>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><p>1、dee插件在致远系统中的数据库是H2内存数据库，猜测由于没有正常停用服务进程导致H2数据库没有正常释放导致此问题。</p>
<p>2、官方反馈原因<br><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/ce47ecc297f7f5c4e035e32b08fe219.png" alt="ce47ecc297f7f5c4e035e32b08fe219"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bigtiao/pic/images/ae78b02e0154845397879b58741ccda.png" alt="ae78b02e0154845397879b58741ccda"></p>
<p>他的意思是， DEE数据库是H2. 是这个数据库的弊端。 如果连接比较频繁，容易造成卡死。一般重启服务是能解决的。总体来说，是DEE本身数据库的弊端</p>
<p>7.1版本，日志是在在同一个数据库文件中dee.mv.db，高并发会出现线程中断，导致文件受损以至于dee任务无法执行；8.1新的版本，dee做了改良，把日志记录的数据给剥离出来了，放到另外的一个数据库文件中，his_mv.db中，能保证dee任务正常使用；</p>
<p>解决方案就是代老师给的三个解决办法。然后把定时器关了，防止有频繁的连接。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">一骗树</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">一骗树</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
